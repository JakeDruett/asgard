"""
Tests for Heimdall Dependency Vulnerability Service

Unit tests for the dependency vulnerability detection service.
"""

import pytest
import tempfile
from pathlib import Path

from Asgard.Heimdall.Security.services.dependency_vulnerability_service import (
    RequirementsParser,
    VulnerabilityDatabase,
    DependencyVulnerabilityService,
)
from Asgard.Heimdall.Security.models.security_models import (
    DependencyRiskLevel,
    SecurityScanConfig,
)


class TestRequirementsParser:
    """Tests for RequirementsParser class."""

    def test_parse_simple_requirements(self):
        """Test parsing simple requirements.txt file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
            f.write("""requests==2.25.0
flask>=2.0.0
django<4.0.0
""")
            temp_path = Path(f.name)

        try:
            deps = RequirementsParser.parse_requirements_txt(temp_path)

            assert "requests" in deps
            assert deps["requests"] == "2.25.0"
            assert "flask" in deps
            assert "django" in deps
        finally:
            temp_path.unlink()

    def test_parse_requirements_with_comments(self):
        """Test parsing requirements with comments."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
            f.write("""# This is a comment
requests==2.25.0
# Another comment
flask>=2.0.0
""")
            temp_path = Path(f.name)

        try:
            deps = RequirementsParser.parse_requirements_txt(temp_path)

            assert len(deps) == 2
            assert "requests" in deps
            assert "flask" in deps
        finally:
            temp_path.unlink()

    def test_parse_requirements_with_extras(self):
        """Test parsing requirements with extras."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
            f.write("""requests[security]==2.25.0
""")
            temp_path = Path(f.name)

        try:
            deps = RequirementsParser.parse_requirements_txt(temp_path)

            assert "requests" in deps
        finally:
            temp_path.unlink()

    def test_parse_requirements_ignores_git_urls(self):
        """Test that git URLs are ignored."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
            f.write("""requests==2.25.0
git+https://github.com/user/repo.git
""")
            temp_path = Path(f.name)

        try:
            deps = RequirementsParser.parse_requirements_txt(temp_path)

            assert len(deps) == 1
            assert "requests" in deps
        finally:
            temp_path.unlink()

    def test_parse_nonexistent_file(self):
        """Test parsing nonexistent file returns empty dict."""
        deps = RequirementsParser.parse_requirements_txt(Path("/nonexistent.txt"))
        assert deps == {}

    def test_parse_pyproject_toml_missing_tomllib(self):
        """Test pyproject.toml parsing when tomllib not available."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.toml', delete=False) as f:
            f.write("""[project]
dependencies = ["requests==2.25.0"]
""")
            temp_path = Path(f.name)

        try:
            deps = RequirementsParser.parse_pyproject_toml(temp_path)
            assert isinstance(deps, dict)
        finally:
            temp_path.unlink()

    def test_parse_setup_py(self):
        """Test parsing setup.py file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
            f.write("""
setup(
    name='mypackage',
    install_requires=[
        'requests>=2.25.0',
        'flask==2.0.0',
    ]
)
""")
            temp_path = Path(f.name)

        try:
            deps = RequirementsParser.parse_setup_py(temp_path)

            assert "requests" in deps or "flask" in deps
        finally:
            temp_path.unlink()


class TestVulnerabilityDatabase:
    """Tests for VulnerabilityDatabase class."""

    def test_known_vulnerabilities_exist(self):
        """Test that known vulnerabilities are defined."""
        assert len(VulnerabilityDatabase.KNOWN_VULNERABILITIES) > 0
        assert "requests" in VulnerabilityDatabase.KNOWN_VULNERABILITIES

    def test_check_vulnerable_package(self):
        """Test checking a vulnerable package version."""
        vulns = VulnerabilityDatabase.check_package("requests", "2.25.0")

        if len(vulns) > 0:
            assert vulns[0].package_name == "requests"
            assert vulns[0].installed_version == "2.25.0"

    def test_check_safe_package_version(self):
        """Test checking a safe package version."""
        vulns = VulnerabilityDatabase.check_package("requests", "2.32.0")

        assert len(vulns) == 0

    def test_check_unknown_package(self):
        """Test checking an unknown package."""
        vulns = VulnerabilityDatabase.check_package("unknown-package-xyz", "1.0.0")

        assert len(vulns) == 0

    def test_version_comparison(self):
        """Test version comparison logic."""
        assert VulnerabilityDatabase._version_is_affected("2.25.0", "<2.31.0") is True
        assert VulnerabilityDatabase._version_is_affected("2.32.0", "<2.31.0") is False

    def test_version_range_comparison(self):
        """Test version range comparison."""
        assert VulnerabilityDatabase._version_is_affected("4.1.0", ">=4.0,<4.2.10") is True
        assert VulnerabilityDatabase._version_is_affected("4.2.10", ">=4.0,<4.2.10") is False
        assert VulnerabilityDatabase._version_is_affected("3.9.0", ">=4.0,<4.2.10") is False

    def test_wildcard_version_not_affected(self):
        """Test that wildcard versions are not flagged as affected."""
        assert VulnerabilityDatabase._version_is_affected("*", "<2.0.0") is False

    def test_parse_version(self):
        """Test version string parsing."""
        assert VulnerabilityDatabase._parse_version("2.25.1") == [2, 25, 1]
        assert VulnerabilityDatabase._parse_version("1.0") == [1, 0, 0]

    def test_map_risk_level(self):
        """Test risk level mapping."""
        assert VulnerabilityDatabase._map_risk_level("critical") == DependencyRiskLevel.CRITICAL
        assert VulnerabilityDatabase._map_risk_level("high") == DependencyRiskLevel.HIGH
        assert VulnerabilityDatabase._map_risk_level("medium") == DependencyRiskLevel.MODERATE


class TestDependencyVulnerabilityService:
    """Tests for DependencyVulnerabilityService class."""

    def test_service_initialization(self):
        """Test service initialization."""
        service = DependencyVulnerabilityService()

        assert service.config is not None

    def test_scan_nonexistent_path_raises_error(self):
        """Test scanning nonexistent path raises error."""
        service = DependencyVulnerabilityService()

        with pytest.raises(FileNotFoundError):
            service.scan(Path("/nonexistent/path"))

    def test_scan_directory_without_requirements(self):
        """Test scanning directory with no requirements files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            service = DependencyVulnerabilityService()
            report = service.scan(Path(tmpdir))

            assert report.total_dependencies == 0
            assert report.vulnerable_dependencies == 0

    def test_scan_with_requirements_txt(self):
        """Test scanning with requirements.txt file."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
flask==2.0.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            assert report.total_dependencies >= 2
            assert len(report.requirements_files) > 0

    def test_scan_detects_vulnerable_packages(self):
        """Test detection of vulnerable packages."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            if report.vulnerable_dependencies > 0:
                assert len(report.vulnerabilities) > 0

    def test_scan_excludes_node_modules(self):
        """Test that node_modules is excluded from scan."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            node_modules = tmpdir_path / "node_modules"
            node_modules.mkdir()
            (node_modules / "package.json").write_text("{}")

            (tmpdir_path / "requirements.txt").write_text("requests==2.25.0")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            req_files = " ".join(report.requirements_files)
            assert "node_modules" not in req_files

    def test_get_upgrade_recommendations(self):
        """Test getting upgrade recommendations."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            recommendations = service.get_upgrade_recommendations(report)

            assert isinstance(recommendations, dict)

    def test_upgrade_recommendations_highest_version(self):
        """Test that recommendations use highest fixed version."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            recommendations = service.get_upgrade_recommendations(report)

            if "requests" in recommendations:
                version_parts = recommendations["requests"].split(".")
                assert len(version_parts) >= 2

    def test_scan_duration_recorded(self):
        """Test that scan duration is recorded."""
        with tempfile.TemporaryDirectory() as tmpdir:
            service = DependencyVulnerabilityService()
            report = service.scan(Path(tmpdir))

            assert report.scan_duration_seconds >= 0.0

    def test_vulnerabilities_sorted_by_risk(self):
        """Test that vulnerabilities are sorted by risk level."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
django==4.0.0
flask==2.3.0
pyyaml==3.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            if len(report.vulnerabilities) > 1:
                risk_order = ["critical", "high", "moderate", "low", "safe"]
                risks = [v.risk_level for v in report.vulnerabilities]

                for i in range(len(risks) - 1):
                    curr_idx = risk_order.index(risks[i])
                    next_idx = risk_order.index(risks[i + 1])
                    assert curr_idx <= next_idx

    def test_vulnerability_includes_cve(self):
        """Test that vulnerabilities include CVE IDs."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            if len(report.vulnerabilities) > 0:
                vuln = report.vulnerabilities[0]
                if vuln.cve_id:
                    assert "CVE-" in vuln.cve_id

    def test_vulnerability_includes_fix_version(self):
        """Test that vulnerabilities include fixed version."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("""requests==2.25.0
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            if len(report.vulnerabilities) > 0:
                for vuln in report.vulnerabilities:
                    if vuln.fixed_version:
                        assert len(vuln.fixed_version) > 0

    def test_scan_multiple_requirements_files(self):
        """Test scanning with multiple requirements files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "requirements.txt").write_text("requests==2.25.0")
            (tmpdir_path / "requirements-dev.txt").write_text("pytest==6.0.0")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            assert len(report.requirements_files) >= 2

    def test_scan_pyproject_toml(self):
        """Test scanning pyproject.toml file."""
        with tempfile.TemporaryDirectory() as tmpdir:
            tmpdir_path = Path(tmpdir)

            (tmpdir_path / "pyproject.toml").write_text("""[project]
dependencies = ["requests==2.25.0"]
""")

            service = DependencyVulnerabilityService()
            report = service.scan(tmpdir_path)

            assert len(report.requirements_files) > 0

    def test_version_is_higher_comparison(self):
        """Test version comparison helper."""
        service = DependencyVulnerabilityService()

        assert service._version_is_higher("2.32.0", "2.31.0") is True
        assert service._version_is_higher("2.30.0", "2.31.0") is False
        assert service._version_is_higher("3.0.0", "2.31.0") is True
